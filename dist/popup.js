(()=>{"use strict";var e={874:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function c(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const o=n(623),r=n(177),s=n(170),c=n(561);function a(e){const t=document.getElementById("spotify-login-notification"),n=document.getElementById("spotify-player");switch(e){case"spotify-player-box":n.style.display="flex",t.style.display="none";break;case"please-login-box":n.style.display="none",t.style.display="flex"}}t.App=class{constructor(){this.token=null,this.track=null}render(){return i(this,void 0,void 0,(function*(){this.token=yield c.getAccessToken(),this.device=yield s.getDeviceID(this.token.accessToken)[0],this.isLoggedIn()?(yield this.showPlayerUI(),s.registerEvents(this.token,this.device.device_id,this.track,this.render.bind(this))):a("please-login-box")}))}showPlayerUI(){return i(this,void 0,void 0,(function*(){a("spotify-player-box");const e=r.Cache.retrieve(o.STORAGE_KEY);this.track=yield this.getTrack(e),c.isUpdateStorage(e,this.track)?r.Cache.storeWithKey(o.STORAGE_KEY,this.track):this.track?this.track=e:this.track=Object.assign(Object.assign({},e),{isPlaying:!1}),this.displayTrackInfo(),this.startTimer(),s.displayControlItems("play")}))}isLoggedIn(){return!this.token.isAnonymous}getTrack(e){return i(this,void 0,void 0,(function*(){let t,n=yield c.getRecentPlayback(this.token.accessToken);switch(n?n.item||(t="no-song-playing"):t=e?"cache":"nothing",t){case"nothing":case"no-song-playing":n=yield c.getRecentlyPlayedTrack(this.token.accessToken);break;case"cache":n=e}return n=c.parse(n),n}))}displayTrackInfo(){return i(this,void 0,void 0,(function*(){const e=this.track,t=document.getElementById("title"),n=document.getElementById("artist"),i=document.getElementById("cover-photo-wrapper"),{title:o,artist:r,coverPhoto:s,trackUrl:c}=e;if(o&&(t.textContent=o,t.setAttribute("title",o),t.setAttribute("href",c),t.setAttribute("target","_blank"),t.style.textDecoration="none",t.style.fontWeight="bold"),r&&(n.textContent=r.name,n.setAttribute("title",r.name),n.setAttribute("href",r.url),n.setAttribute("target","_blank"),n.style.textDecoration="none",n.style.fontStyle="italic"),s){const e=document.createElement("img");e.setAttribute("src",s),e.setAttribute("id","cover-photo"),e.setAttribute("class","mini-spotify-right-panel mini-spotify-cover-photo"),e.setAttribute("title",`${o} - ${r.name}`),e.setAttribute("alt",`${o} - ${r.name}`),document.getElementById("cover-photo")&&i.removeChild(document.getElementById("cover-photo")),i.append(e)}}))}startTimer(){if(!this.track)return;const e=this.track.durationMs,t=this.track.progressMs||0,n=setTimeout((()=>i(this,void 0,void 0,(function*(){yield this.showPlayerUI(),clearTimeout(n)}))),e-t)}togglePlay(){this.track.isPlaying?s.displayControlItems("pause"):s.displayControlItems("play")}}},177:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Cache=void 0,t.Cache=class{static retrieve(e){let t;try{t=JSON.parse(localStorage.getItem(e))}catch(e){t=void 0}return t}static storeWithKey(e,t){localStorage.setItem(e,JSON.stringify(t))}}},623:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HOUR_IN_SECOND=t.STORAGE_KEY=t.CONTEXT_MENU_ITEM_TEXT=t.CONTEXT_MENU_ITEM=t.API_URL=t.WEB_PLAYER_URL=void 0,t.WEB_PLAYER_URL="https://open.spotify.com",t.API_URL="https://api.spotify.com",t.CONTEXT_MENU_ITEM="spotify-extension-search-on-spotify",t.CONTEXT_MENU_ITEM_TEXT='Search Spotify for "%s"',t.STORAGE_KEY="storage",t.HOUR_IN_SECOND=3600},170:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function c(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.displayControlItems=t.registerEvents=t.playTrack=t.pauseTrack=t.getDeviceID=void 0;const o=n(623);function r(e,t){return i(this,void 0,void 0,(function*(){const n=`${o.API_URL}/v1/me/player/pause?device_id=${e}`;try{return yield fetch(n,{method:"PUT",headers:{Authorization:`Bearer ${t}`}})}catch(e){throw e}}))}function s(e,t,n){return i(this,void 0,void 0,(function*(){const i=`${o.API_URL}/v1/me/player/play?device_id=${t}`,r={position_ms:e.progressMs};try{return yield fetch(i,{method:"PUT",body:JSON.stringify(r),headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}})}catch(e){throw e}}))}function c(e){return i(this,void 0,void 0,(function*(){var t=document.getElementById("play"),n=document.getElementById("pause");switch(e){case"play":t.style.display="none",n.style.display="flex";break;case"pause":t.style.display="flex",n.style.display="none"}}))}t.getDeviceID=function(e){return i(this,void 0,void 0,(function*(){const t=`${o.API_URL}/v1/me/player/devices`;try{const n=yield fetch(t,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),i=yield n.json();return console.log(i),i}catch(e){console.log("getdeviceiderror: "+e)}}))},t.pauseTrack=r,t.playTrack=s,t.registerEvents=function(e,t,n,o){document.getElementById("prev");const a=document.getElementById("pause"),l=document.getElementById("play");function u(){return i(this,void 0,void 0,(function*(){c("play"),yield r(t,e.accessToken)}))}function d(){return i(this,void 0,void 0,(function*(){c("pause"),yield s(n,t,e.accessToken)}))}document.getElementById("next"),document.getElementById("save"),document.getElementById("un-save"),document.getElementById("repeat"),document.addEventListener("keydown",(e=>i(this,void 0,void 0,(function*(){e.preventDefault(),"Space"===e.code&&(!0===n.isPlaying?yield u():yield d())})))),a.onclick=function(e){return i(this,void 0,void 0,(function*(){e.preventDefault(),yield u()}))},l.onclick=function(e){return i(this,void 0,void 0,(function*(){e.preventDefault(),yield d()}))}},t.displayControlItems=c},561:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function c(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.parse=t.parseDevice=t.isUpdateStorage=t.getRecentlyPlayedTrack=t.getRecentPlayback=t.getAccessToken=t.getMyDevice=void 0;const o=n(623);t.getMyDevice=function(e){return i(this,void 0,void 0,(function*(){const t=`${o.API_URL}/v1/me/player/devices`;try{const n=yield fetch(t,{headers:{Authorization:`Bearer ${e}`}});return console.log("DEVICE "+n),n}catch(e){}}))},t.getAccessToken=function(){return i(this,void 0,void 0,(function*(){let e={clientId:null,accessToken:null,accessTokenExpirationTime:null,isAnonymous:null};try{const t=`${o.WEB_PLAYER_URL}/get_access_token`,n=yield fetch(t);e=yield n.json()}catch(e){}return e}))},t.getRecentPlayback=function(e){return i(this,void 0,void 0,(function*(){const t=`${o.API_URL}/v1/me/player?additional_types=track`;try{const n=yield fetch(t,{headers:{Authorization:`Bearer ${e}`}});return yield n.json()}catch(e){return!1}}))},t.getRecentlyPlayedTrack=function(e){return i(this,void 0,void 0,(function*(){const t=`${o.API_URL}/v1/me/player/recently-played`;try{const n=yield fetch(t,{headers:{Authorization:`Bearer ${e}`}});let i=yield n.json();if(i&&i.items.length){const{track:e,context:t}=i.items[0];return{item:e,context:t}}return}catch(e){return}}))},t.isUpdateStorage=function(e,t){return!!(!e||t&&t.title!==e.title||t&&t.isPlaying!==e.isPlaying||t&&t.uri!==e.uri||t&&t.uri===e.uri&&t.progressMs!==e.progressMs||t&&t.uri===e.uri&&t.isSave!==e.isSave||t&&t.uri===e.uri&&t.repeatState!==e.repeatState)},t.parseDevice=function(e){return i(this,void 0,void 0,(function*(){if(null==e)return;const t=yield e.json();var n=["Computer"];return(t.devices?t.devices.filter((e=>n.indexOf(e.type)>-1)).map((e=>({id:e.id,isActive:e.is_active,isRestricted:e.is_restricted,name:e.name,type:e.type,volumePercent:e.volume_percent}))):[])[0]}))},t.parse=function(e){if(!e||e&&!e.item)return;const{is_playing:t,progress_ms:n,repeat_state:i,item:{name:o,artists:r,album:{images:s},uri:c,id:a,duration_ms:l,external_urls:{spotify:u}}}=e;let d="",y="";(null==r?void 0:r.length)&&(d=r[0].name,y=r[0].external_urls.spotify);const h=(null==s?void 0:s.length)?s[1].url:"";let p;if(e.context){const{type:t,href:n,external_urls:i,uri:o}=e.context;p={type:t,href:n,uri:o,externalUrls:i}}return{title:o,artist:{name:d,url:y},repeatState:i,isPlaying:t,coverPhoto:h,uri:c,progressMs:n,context:p,durationMs:l,trackUrl:u,id:a}}},975:(e,t,n)=>{(new(n(874).App)).render()}},t={};!function n(i){if(t[i])return t[i].exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}(975)})();